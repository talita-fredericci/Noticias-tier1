<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Hedgepoint — Cards (Lite c/ cotas por commodity)</title>
<style>
  :root{--hp-orange:#ED8B00;--hp-blue:#272259;--hp-white:#fff;--hp-bg:#0f0f12;--hp-card:#12141a}
  *{box-sizing:border-box}
  body{margin:0;background:var(--hp-bg);color:var(--hp-white);font-family:Montserrat,Arial,Helvetica,sans-serif}
  .hp-wrap{max-width:1120px;margin:28px auto;padding:0 16px}

  /* Viewport com scroll-snap (leve) */
  .hp-viewport{display:flex;overflow:auto;scroll-snap-type:x mandatory;gap:14px;padding-bottom:6px;border:2px solid var(--hp-blue)}
  .hp-viewport::-webkit-scrollbar{height:8px}
  .hp-viewport::-webkit-scrollbar-thumb{background:#29304a}
  .hp-slide{scroll-snap-align:start;flex:0 0 100%}
  @media (min-width:720px){ .hp-slide{flex-basis:calc(50% - 7px)} }
  @media (min-width:1024px){ .hp-slide{flex-basis:calc(33.333% - 9.5px)} }

  /* Card enxuto (sem cantos arredondados) */
  .hp-card{border:1.5px solid var(--hp-blue);background:var(--hp-card);display:flex;flex-direction:column;height:100%}
  .hp-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1.5px solid #1c2030}
  .hp-pill{padding:2px 8px;border:1.5px solid var(--hp-orange);font-size:11px;letter-spacing:.02em;text-transform:uppercase}
  .hp-veh{font-size:12px;color:#c8c8c8}
  .hp-body{padding:12px}
  .hp-title{margin:0 0 10px 0;line-height:1.3}
  .hp-title a{color:#fff;text-decoration:none;border-bottom:2px solid transparent}
  .hp-title a:hover{border-color:var(--hp-orange)}
  .hp-exp{margin-top:auto;display:flex;align-items:center;gap:10px;padding:12px;border-top:1.5px solid #1c2030;background:linear-gradient(0deg,#0b0d12,#0f1117)}
  .hp-exp img{width:44px;height:44px;object-fit:cover;border:2px solid var(--hp-blue)}
  .hp-who{display:flex;flex-direction:column}
  .hp-name{font-weight:700}
  .hp-role{font-size:12px;color:#c8c8c8}
  @media (max-width:720px){.hp-role{display:none}}

  /* Nav setas leves (usam scroll, não transform) */
  .hp-nav{display:flex;justify-content:space-between;margin:10px 0 0}
  .hp-btn{border:2px solid var(--hp-orange);background:transparent;color:#fff;padding:6px 10px;cursor:pointer}
  .hp-btn:hover{background:var(--hp-orange);color:#000}
</style>
</head>
<body>
  <div class="hp-wrap">
    <div id="hpViewport" class="hp-viewport" aria-roledescription="carousel" aria-label="Notícias com especialista"></div>
    <div class="hp-nav">
      <button class="hp-btn" id="prevBtn" aria-label="Anterior">←</button>
      <button class="hp-btn" id="nextBtn" aria-label="Próximo">→</button>
    </div>
  </div>

<script>
/* ===== CONFIG ===== */
const CONFIG = {
  CSV_URL: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQEVY2tjAstOUFhopJ05zJoPq1l979hSuc2N01pF4v8nEdm4EKk7p08A2X1adlyBcxTEgIvNJxz574g/pub?gid=1592806276&single=true&output=csv',
  MAX_CARDS: 12,
  FILTERS:{
    year: 2025,              // defina null para não filtrar por ano
    tier1Only: true,         // Tier 1 ligado
    tier1List: [
      'Valor Econômico','Estadão','Folha de S.Paulo','O Globo','Agência Estado',
      'Reuters','Bloomberg','Financial Times'
    ]
  },
  SELECTION:{                // garante representatividade
    byTheme: true,
    themes: ['oleaginosas','grãos','café','açúcar','cacau'],
    perTheme: 2,             // até 2 mais recentes por commodity
    fallbackNonTier1: false  // mude para true se quiser completar a cota com não-Tier1 quando faltar
  },
  SPECIALISTS:{
    'café':        { name:'Laleska Moda',    role:'Analista de Inteligência de Mercado',         photo:'https://9334756.fs1.hubspotusercontent-na1.net/hubfs/9334756/Mkt%20Intell%20-%20Seta%20laranja/Laleska%20Moda.png' },
    'oleaginosas': { name:'Thais Italiani',  role:'Gerente de Inteligência de Mercados',         photo:'https://9334756.fs1.hubspotusercontent-na1.net/hubfs/9334756/Mkt%20Intell%20-%20Seta%20laranja/Thais%20Italiani.png' },
    'cacau':       { name:'Carolina França', role:'Analista Sênior de Inteligência de Mercado',  photo:'https://9334756.fs1.hubspotusercontent-na1.net/hubfs/9334756/Mkt%20Intell%20-%20Seta%20laranja/Carol%20Fran%C3%A7a.png' },
    'açúcar':      { name:'Lívea Coda',      role:'Coordenadora de Inteligência de Mercado',     photo:'https://9334756.fs1.hubspotusercontent-na1.net/hubfs/9334756/Mkt%20Intell%20-%20Seta%20laranja/L%C3%ADvea%20Coda.png' },
    'grãos':       { name:'Luiz Roque',      role:'Coordenador de Inteligência de Mercado',      photo:'https://9334756.fs1.hubspotusercontent-na1.net/hubfs/9334756/Mkt%20Intell%20-%20Seta%20laranja/Luiz%20Roque.png' }
  },
  UTM:{enabled:true, source:'news-cards', medium:'referral', campaign:'press-mentions'}
};

/* ===== Utils ===== */
const strip=s=>(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'');
const lower=s=>strip(String(s||'')).toLowerCase();
const vehCanon=s=>lower(s).replace(/[^\w]+/g,' ').trim();
const TIER1 = new Set(CONFIG.FILTERS.tier1List.map(vehCanon));

function themeOf(raw){
  const s=lower(raw);
  if(/(soja|oleagin|canola|girassol|sunflower|colza)/.test(s)) return 'oleaginosas';
  if(/(milho|corn|trigo|wheat|sorgo|grao|gr[ãa]os)/.test(s))   return 'grãos';
  if(/(cafe|coffee|arabica|robusta)/.test(s))                 return 'café';
  if(/(acucar|a[cç]ucar|sugar|etanol|ethanol|cana)/.test(s))  return 'açúcar';
  if(/(cacau|cocoa|chocolate)/.test(s))                       return 'cacau';
  return 'grãos';
}
const specOf=t=>CONFIG.SPECIALISTS[t]||CONFIG.SPECIALISTS['grãos'];

function withUTM(url){
  if(!url||!CONFIG.UTM.enabled) return url;
  try{const u=new URL(url);
    if(!u.searchParams.get('utm_source')) u.searchParams.set('utm_source',CONFIG.UTM.source);
    if(!u.searchParams.get('utm_medium')) u.searchParams.set('utm_medium',CONFIG.UTM.medium);
    if(!u.searchParams.get('utm_campaign')) u.searchParams.set('utm_campaign',CONFIG.UTM.campaign);
    return u.toString();
  }catch{return url}
}

function parseDate(s){
  if(!s) return null; s=String(s).trim();
  let d=new Date(s); if(!isNaN(d)) return d;
  const m=s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
  if(m){ const dd=+m[1], mm=+m[2], yy=m[3].length===2?2000+(+m[3]):+m[3]; d=new Date(yy,mm-1,dd); if(!isNaN(d)) return d; }
  return null;
}

/* CSV parser simples (com aspas) */
function parseCSV(text){
  const out=[], re=/\s*(?:\"([^\"]*(?:\"\"[^\"]*)*)\"|([^,]*))\s*(,|\n|\r|$)/g; let m,row=[];
  text=text.replace(/\r\n/g,'\n').replace(/\r/g,'\n');
  while((m=re.exec(text))){ const v=m[1]?m[1].replace(/\"\"/g,'\"'):m[2]; row.push(v); const sep=m[3]; if(sep==='\n'||sep===''){out.push(row);row=[];} }
  if(row.length) out.push(row);
  const [h,...data]=out; if(!h) return [];
  const idx={}; h.forEach((x,i)=>idx[lower(x)]=i);
  return data.map(r=>({
    titulo:    r[idx['titulo']] ?? r[idx['nome da noticia']] ?? r[idx['nome da notícia']] ?? r[0],
    veiculo:   r[idx['veiculo']] ?? r[idx['veículo']] ?? r[1],
    data:      r[idx['datapublicacao']] ?? r[idx['data']] ?? '',
    commodity: r[idx['commodity']] ?? r[idx['categoria']] ?? r[idx['tema']] ?? r[2],
    url:       r[idx['url']] ?? r[idx['link']] ?? r[3]
  })).filter(x=>x.titulo && (x.url||x.veiculo));
}

/* Dedup + Filtros */
function dedup(list){
  const su=new Set(), st=new Set();
  return list.filter(it=>{
    let ok=true;
    if(it.url){ const k=lower(it.url.replace(/^https?:\/\//,'')); if(su.has(k)) ok=false; else su.add(k); }
    const k2=lower(it.titulo); if(st.has(k2)) ok=false; else st.add(k2);
    return ok;
  });
}
function filterYear(rows, year){
  if(!year) return rows;
  return rows.filter(r=>{ const d=parseDate(r.data); return d && d.getFullYear()===year; });
}
function filterTier1(rows){
  if(!CONFIG.FILTERS.tier1Only) return rows;
  return rows.filter(r=>TIER1.has(vehCanon(r.veiculo||'')));
}

/* ===== Seleção com cotas por commodity ===== */
function pickQuotaByTheme(rowsStrict, rowsYearOnly){
  const THEMES = CONFIG.SELECTION.themes;
  const PER = CONFIG.SELECTION.perTheme;
  const fallback = CONFIG.SELECTION.fallbackNonTier1;

  // agrupa e ordena (mais recentes primeiro)
  const byThemeStrict = Object.fromEntries(THEMES.map(t=>[t,[]]));
  rowsStrict.forEach(r=>{ const t=themeOf(r.commodity); if(byThemeStrict[t]) byThemeStrict[t].push(r); });
  THEMES.forEach(t=>byThemeStrict[t].sort((a,b)=> (parseDate(b.data)-parseDate(a.data)) || 0));

  // fallback (ano apenas) quando não houver o suficiente no strict
  const byThemeYearOnly = Object.fromEntries(THEMES.map(t=>[t,[]]));
  if(fallback){
    rowsYearOnly.forEach(r=>{ const t=themeOf(r.commodity); if(byThemeYearOnly[t]) byThemeYearOnly[t].push(r); });
    THEMES.forEach(t=>byThemeYearOnly[t].sort((a,b)=> (parseDate(b.data)-parseDate(a.data)) || 0));
  }

  // coleta até PER por tema, com fallback opcional
  const pickedPerTheme = Object.fromEntries(THEMES.map(t=>[t,[]]));
  const seen = new Set();
  const keyOf = r => (r.url || r.titulo);

  THEMES.forEach(t=>{
    const want = PER;
    const fromStrict = byThemeStrict[t] || [];
    for(const r of fromStrict){
      const k = keyOf(r); if(seen.has(k)) continue;
      pickedPerTheme[t].push(r); seen.add(k);
      if(pickedPerTheme[t].length>=want) break;
    }
    if(pickedPerTheme[t].length<want && fallback){
      for(const r of (byThemeYearOnly[t]||[])){
        const k=keyOf(r); if(seen.has(k)) continue;
        pickedPerTheme[t].push(r); seen.add(k);
        if(pickedPerTheme[t].length>=want) break;
      }
    }
  });

  // interleave (round-robin) para balancear na vitrine
  const interleaved=[];
  for(let i=0;i<PER;i++){
    for(const t of THEMES){
      const item = pickedPerTheme[t][i];
      if(item) interleaved.push(item);
    }
  }

  // preenche sobras com os mais recentes do strict (de outros temas) até MAX_CARDS
  if(interleaved.length<CONFIG.MAX_CARDS){
    const rest = rowsStrict.filter(r=>!seen.has(keyOf(r)))
      .sort((a,b)=> (parseDate(b.data)-parseDate(a.data)) || 0);
    for(const r of rest){
      interleaved.push(r);
      if(interleaved.length>=CONFIG.MAX_CARDS) break;
    }
  }

  return interleaved.slice(0, CONFIG.MAX_CARDS);
}

/* Render de 1 card */
function cardHTML(row){
  const theme=themeOf(row.commodity), sp=specOf(theme), link=row.url?withUTM(row.url):null;
  const d=parseDate(row.data), dateTxt=d? d.toLocaleDateString('pt-BR') : (row.data||'');
  return `<div class="hp-slide">
    <article class="hp-card">
      <div class="hp-head"><span class="hp-pill">\${theme.toUpperCase()}</span><span class="hp-veh">\${row.veiculo||''}\${dateTxt?` • \${dateTxt}`:''}</span></div>
      <div class="hp-body"><h3 class="hp-title">\${link?`<a href="\${link}" target="_blank" rel="noopener">\${row.titulo}</a>`:row.titulo}</h3></div>
      <div class="hp-exp"><img src="\${sp.photo}" alt="\${sp.name}" loading="lazy" decoding="async"><div class="hp-who"><span class="hp-name">\${sp.name}</span><span class="hp-role">\${sp.role}</span></div></div>
    </article>
  </div>`;
}

/* Autoplay por scroll (suave) */
const vp=document.getElementById('hpViewport');
const prevBtn=document.getElementById('prevBtn');
const nextBtn=document.getElementById('nextBtn');
let autoT=null, PAGE=0;

function pageWidth(){ return vp.clientWidth; }
function pagesCount(){ return Math.max(1, Math.ceil(vp.scrollWidth / pageWidth())); }
function goPage(p){ PAGE=p; vp.scrollTo({left: p*pageWidth(), behavior:'smooth'}); }
function next(){ goPage( (PAGE+1) % pagesCount() ); }
function prev(){ goPage( (PAGE-1+pagesCount()) % pagesCount() ); }
function startAuto(){ stopAuto(); autoT=setInterval(next, 6000); }
function stopAuto(){ if(autoT){ clearInterval(autoT); autoT=null; } }

prevBtn.addEventListener('click', ()=>{ prev(); startAuto(); });
nextBtn.addEventListener('click', ()=>{ next(); startAuto(); });
vp.addEventListener('mouseenter', stopAuto);
vp.addEventListener('mouseleave', startAuto);
window.addEventListener('resize', ()=>{ goPage(0); });

/* Boot */
(async function(){
  try{
    const res=await fetch(CONFIG.CSV_URL,{cache:'no-store'});
    const txt=await res.text();
    const all = dedup(parseCSV(txt));

    // conjuntos para seleção
    const yearOnly = filterYear(all, CONFIG.FILTERS.year);
    const strict   = filterTier1(yearOnly);

    // seleção com cotas por commodity
    let rows;
    if(CONFIG.SELECTION.byTheme){
      rows = pickQuotaByTheme(strict, yearOnly);
    }else{
      rows = strict.slice(0, CONFIG.MAX_CARDS);
    }

    vp.innerHTML = rows.map(cardHTML).join('') || '<div style="padding:18px;border:1.5px dashed #2a2d36;color:#9ca3af">Nenhuma notícia para exibir.</div>';
    goPage(0); startAuto();
  }catch(e){
    vp.innerHTML = '<div style="padding:18px;border:1.5px dashed #2a2d36;color:#9ca3af">Falha ao carregar CSV.</div>';
    console.warn('CSV error', e);
  }
})();
</script>
</body>
</html>
