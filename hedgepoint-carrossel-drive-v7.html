<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Hedgepoint | Carrossel de Notícias</title>
<style>
  :root{
    --hp-orange:#ED8B00;
    --hp-black:#000000;
    --hp-white:#FFFFFF;
    --hp-gray:#4D4C4D;
    --radius:10px;
    --tag-radius:6px;

    /* << ajuste aqui para controlar o quanto o viewport é maior que o card */
    --peek:24px;            /* 24px de “folga” além do card */
    --gap:14px;             /* espaçamento entre cards */
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Open Sans","Helvetica Neue",Arial,sans-serif;color:var(--hp-black);background:var(--hp-white);}
  .hp-wrap{--pad:clamp(10px,2vw,18px);padding:var(--pad);max-width:900px;margin:0 auto;position:relative;}
  .hp-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;}
  .hp-title{font-weight:700;letter-spacing:.3px;font-size:clamp(18px,2.3vw,21px);}

  /* === 1 card por vez; o card mede (100% - --peek) === */
  .hp-track{
    display:grid;
    grid-auto-flow:column;
    grid-auto-columns: calc(100% - var(--peek));
    gap:var(--gap);
    overflow-x:auto;
    scroll-snap-type:x mandatory;
    scroll-behavior:smooth;
    /* padding cria o “respiro” para centralizar o card */
    padding: var(--pad) calc(var(--peek)/2) var(--pad);
  }
  .hp-track::-webkit-scrollbar{height:8px}
  .hp-track::-webkit-scrollbar-thumb{background:#ddd;border-radius:999px}

  .hp-card{
    position:relative; scroll-snap-align:start;
    border:1px solid #eee; border-radius:var(--radius); overflow:hidden;
    background:var(--hp-white); box-shadow:0 2px 10px rgba(0,0,0,.06);
    display:flex; flex-direction:column; min-height:340px;
  }

  /* Imagem mais baixa para card compacto */
  .hp-media{ aspect-ratio:21/10; background:#f4f4f4; overflow:hidden; }
  .hp-media img{ width:100%; height:100%; object-fit:cover; display:block; object-position:center 38%; }

  .hp-body{ display:flex; flex-direction:column; gap:6px; padding:12px 12px 10px; }

  .hp-expert{ font-size:clamp(17px,2vw,19px); color:var(--hp-orange); font-weight:800; line-height:1.2; letter-spacing:.2px; }

  .hp-commodity{ align-self:flex-start; background:var(--hp-orange); color:var(--hp-white);
    font-weight:800; font-size:12px; padding:5px 9px; border-radius:var(--tag-radius); letter-spacing:.3px; }

  .hp-titlecard{ font-size:clamp(15px,1.75vw,16.5px); line-height:1.28; font-weight:700; margin:0; }
  .hp-titlecard a{ color:inherit; text-decoration:none; }
  .hp-titlecard a:hover{ text-decoration:underline; }

  .hp-meta{ display:flex; align-items:center; gap:8px; color:var(--hp-gray); font-size:13px; margin-top:0; }
  .hp-meta img{ width:16px; height:16px; border-radius:4px; flex:0 0 16px; }

  .hp-nav{ position:absolute; inset:50% auto auto auto; transform:translateY(-50%); width:100%; pointer-events:none; display:flex; justify-content:space-between; gap:8px; }
  .hp-arrow{ pointer-events:auto; background:var(--hp-white); border:1px solid #eaeaea; box-shadow:0 2px 10px rgba(0,0,0,.08); width:42px; height:42px; border-radius:999px; display:grid; place-items:center; cursor:pointer; }
  .hp-arrow:focus-visible{ outline:2px solid var(--hp-orange); outline-offset:2px; }
  .hp-arrow svg{ width:21px; height:21px; }
  .hp-arrow:hover{ filter:brightness(1.03); }

  .hp-empty{ padding:14px; border:1px dashed #ddd; border-radius:var(--radius); color:#666; background:#fafafa; }
</style>
</head>
<body>
  <div class="hp-wrap" role="region" aria-label="Carrossel de notícias da Hedgepoint">
    <div class="hp-head"><div class="hp-title">Insights da nossa equipe &amp; na mídia</div></div>
    <div class="hp-track" id="hpTrack" aria-live="polite"></div>

    <div class="hp-nav" aria-hidden="false">
      <button class="hp-arrow" id="hpPrev" aria-label="Anterior">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M14.8 4.5L7.3 12l7.5 7.5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M10 12h7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
      </button>
      <button class="hp-arrow" id="hpNext" aria-label="Próximo">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M9.2 4.5L16.7 12l-7.5 7.5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M14 12H7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
      </button>
    </div>

    <div id="hpStatus" class="hp-empty" style="display:none"></div>
  </div>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQriFFRu5l_lZvXyKLkk_C32g79FhADcf2XEw9FPUqkd5cg-k_csA5ctbFivtY7TUd8jWTWF2zM95TM/pub?output=csv";

/* Força UTF-8 */
async function fetchCSVUtf8(url){
  const res = await fetch(url, {cache:"no-store"});
  if(!res.ok) throw new Error("Falha ao carregar CSV");
  const buf = await res.arrayBuffer();
  return new TextDecoder("utf-8").decode(buf);
}

/* Conta delimitadores fora de aspas numa linha */
function countDelims(line, delim){
  let inQ=false, c=0;
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(ch === '"'){ inQ = !inQ; continue; }
    if(!inQ && ch===delim) c++;
  }
  return c;
}
/* Detecta , ou ; */
function sniffDelimiter(text){
  const lines = text.split(/\r?\n/).filter(l => l.trim().length>0).slice(0,3);
  let comma=0, semi=0;
  for(const l of lines){ comma += countDelims(l, ','); semi += countDelims(l, ';'); }
  return semi > comma ? ';' : ',';
}
/* Parser CSV com aspas e delimitador dinâmico */
function parseCSV(text, delim){
  const rows=[], DL=delim;
  let i=0, field='', row=[], inQ=false;
  const pushField=()=>{ row.push(field); field=''; };
  const pushRow =()=>{ rows.push(row); row=[]; };
  while(i<text.length){
    const ch=text[i];
    if(inQ){
      if(ch === '"'){ if(text[i+1] === '"'){ field+='"'; i++; } else { inQ=false; } }
      else { field += ch; }
    }else{
      if(ch === '"'){ inQ=true; }
      else if(ch === DL){ pushField(); }
      else if(ch === '\n'){ pushField(); pushRow(); }
      else if(ch === '\r'){ /* ignore */ }
      else { field += ch; }
    }
    i++;
  }
  if(field.length || row.length){ pushField(); pushRow(); }
  return rows;
}

function getFavicon(urlString){
  try{
    const u = new URL(urlString);
    return `https://www.google.com/s2/favicons?sz=32&domain=${u.hostname}`;
  }catch(e){
    return `https://www.google.com/s2/favicons?sz=32&domain=example.com`;
  }
}

function createCard({Titulo, Veiculo, Commodity, Foto, Link, Especialista}){
  const card = document.createElement('article'); card.className='hp-card';

  const media=document.createElement('div'); media.className='hp-media';
  const img=document.createElement('img'); img.loading='lazy'; img.alt=`Especialista - ${Especialista || Titulo || ''}`; img.src=Foto||'';
  media.appendChild(img);

  const body=document.createElement('div'); body.className='hp-body';

  const expert=document.createElement('div'); expert.className='hp-expert'; expert.textContent=(Especialista||'').trim();

  const tag=document.createElement('span'); tag.className='hp-commodity'; tag.textContent=(Commodity||'').toUpperCase();

  const title=document.createElement('h3'); title.className='hp-titlecard';
  const a=document.createElement('a'); a.href=Link||'#'; a.target='_blank'; a.rel='noopener noreferrer'; a.textContent=Titulo||'';
  title.appendChild(a);

  const meta=document.createElement('div'); meta.className='hp-meta';
  const fav=document.createElement('img'); fav.loading='lazy'; fav.alt=''; fav.src=getFavicon(Link||'');
  const src=document.createElement('span'); src.textContent=Veiculo||'';
  meta.append(fav, src);

  if(expert.textContent) body.append(expert);
  body.append(tag);
  body.append(title);
  body.append(meta);

  card.append(media, body);
  return card;
}

async function initCarousel(){
  const track=document.getElementById('hpTrack');
  const status=document.getElementById('hpStatus');

  try{
    const raw=await fetchCSVUtf8(CSV_URL);
    const delim=sniffDelimiter(raw);
    const rows=parseCSV(raw, delim).filter(r => r.length && r.some(c => c && c.trim() !== ''));
    if(rows.length<2){ status.style.display='block'; status.textContent='Nenhuma notícia para exibir no momento.'; return; }

    const header=rows[0].map(h => (h||'').trim());
    const findIdx = (re) => header.findIndex(h => re.test(h));
    const idx={
      Titulo:       findIdx(/^t[ií]tulo|^titulo|^t[íi]tulo/i),
      Veiculo:      findIdx(/^(ve[ií]culo|veiculo|fonte|source|portal|site)/i),
      Commodity:    findIdx(/^(commodity|mercadoria|categoria|tag)/i),
      Foto:         findIdx(/^(foto|imagem|image|headshot|photo)/i),
      Link:         findIdx(/^(link|url)/i),
      Especialista: findIdx(/^(especialista|especialistas|nome|analista|autor)/i)
    };

    for(let r=1; r<rows.length; r++){
      const row=rows[r];
      const data={
        Titulo:       idx.Titulo       >=0 ? (row[idx.Titulo]||'') : '',
        Veiculo:      idx.Veiculo      >=0 ? (row[idx.Veiculo]||'') : '',
        Commodity:    idx.Commodity    >=0 ? (row[idx.Commodity]||'') : '',
        Foto:         idx.Foto         >=0 ? (row[idx.Foto]||'') : '',
        Link:         idx.Link         >=0 ? (row[idx.Link]||'') : '',
        Especialista: idx.Especialista >=0 ? (row[idx.Especialista]||'') : ''
      };
      track.appendChild(createCard(data));
    }

    const prev=document.getElementById('hpPrev');
    const next=document.getElementById('hpNext');

    // Calcula o avanço EXATO de um card (largura do card + gap)
    const getStep = () => {
      const first = track.firstElementChild;
      if(!first) return track.clientWidth;
      const style = getComputedStyle(track);
      const gap = parseFloat(getComputedStyle(track).gap || '0');
      return first.getBoundingClientRect().width + gap;
    };

    prev.addEventListener('click', ()=> track.scrollBy({left:-getStep(),behavior:'smooth'}));
    next.addEventListener('click', ()=> track.scrollBy({left: getStep(),behavior:'smooth'}));

    track.addEventListener('keydown', e => { if(e.key==='ArrowRight') next.click(); if(e.key==='ArrowLeft') prev.click(); });
    track.tabIndex=0;

  }catch(err){
    status.style.display='block';
    status.textContent='Não foi possível carregar os dados agora. Verifique o caminho do CSV.';
    console.error(err);
  }
}
document.addEventListener('DOMContentLoaded', initCarousel);
</script>
</body>
</html>
